<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>US Homicides</title>

    <!--Load jQuery and fullpage tags -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/3.0.1/fullpage.min.js"></script>

    <!-- load d3 -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>

    <!--We will overide some default styles here -->
    <link rel="stylesheet" href='styles.css'>
    <!-- Adding fullpage.css is essential-->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/3.0.1/fullpage.min.css" />
  </head>
  <body>

    <div id="fullpage">
      <div class="section">
        <p>Homicides By State</p>
        <svg id="yearmap" width="960", height="600"></svg>
      </div>
      <div class="section">
        <p>Section 2</p>
        <svg id="circles" width="960", height="960"></svg>
      </div>
      <div class="section">
        <p>Section 3</p>
        <svg id="explore" width="960", height="960"></svg>
      </div>
    </div>

    <!--Custom script -->
    <script type="text/javascript">
      $(document).ready(function(){
        $("#fullpage").fullpage({
          //fullpage options
          licenseKey:"OPEN-SOURCE-GPLV3-LICENSE"
        });  
        buildMap();
      });


      function buildMap() {

        var path = d3.geoPath();
        var homicidesState = {};
        var statesMap = d3.map();
        var mapSvg = d3.select("#yearmap");

        d3.queue()
        .defer(d3.json, "https://d3js.org/us-10m.v1.json")
        .defer(d3.tsv, "https://gist.githubusercontent.com/mbostock/4090846/raw/07e73f3c2d21558489604a0bc434b3a5cf41a867/us-state-names.tsv", function(d) { statesMap.set(d.code, d.id)})
        .defer(d3.csv, "count_by_year_and_state.csv", buildHomicides)
        .await(ready);

        function buildHomicides(homicideData, error) {
          /*var array = d3.nest()
            .key(h => h.state)
            .key(h => h.year)
            .entries(homicideData)
            .map(function(d) {
              var state = statesMap.get(d.key);
              var years = d.values.map(function(sy) {
                  return {year: sy.key, count:sy.values[1].count}
              });
            });

          array.forEach(function(d) {
            homicidesState[d.state] = d.years;
          });
          */
          var stateId = statesMap.get(homicideData.state);
          if(!(stateId in homicidesState)) {
            homicidesState[stateId] = {};
          }
          homicidesState[stateId][homicideData.year] = homicideData.count; 
        }

        function getColor(stateId) {
          if (parseInt(stateId) in homicidesState) {
            var homicidesFor2008 = homicidesState[stateId][2008];
            return "rgb(" + homicidesFor2008 + "," +  homicidesFor2008 * 2 + "," +  homicidesFor2008 / 2 + ")";
          }
          return "gray";

        }

        function ready(error, us) {
          if(error) throw error;

          mapSvg.selectAll("path")
            .data(topojson.feature(us, us.objects.states).features)
            .enter().append("path")
              .attr("fill", function(d) { return getColor(d.id) })
              .attr("d", path);
          mapSvg.append("path")
            .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
            .attr("class", "state-borders")
            .attr("d", path);
        }
      }
    </script>
  </body>
</html>